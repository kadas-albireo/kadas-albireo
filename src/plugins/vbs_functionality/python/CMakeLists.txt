SET (QGIS_PYTHON_OUTPUT_DIRECTORY ${QGIS_OUTPUT_DIRECTORY}/python/qgis)
SET (QGIS_VBS_PYTHON_OUTPUT_DIRECTORY ${QGIS_OUTPUT_DIRECTORY}/python/qgis/vbs)

INCLUDE_DIRECTORIES(
  ${PYTHON_INCLUDE_PATH}
  ${GDAL_INCLUDE_DIR} # HACK: SIP_INCLUDE_DIR is wrong under windows, we need <OSGeo4W>\include, not <OSGeo4W>\apps\Python27\include. Abusing of GDAL_INCLUDE_DIR since it happens to point to <OSGeo4W>\include
  ${SIP_INCLUDE_DIR}
  ..
  ../../../core
)

IF(WIN32)
    ADD_DEFINITIONS("\"-DVBS_EXPORT=${DLLIMPORT}\"")
ELSE(WIN32)
    ADD_DEFINITIONS("-DVBS_EXPORT=")
ENDIF(WIN32)


SET(SIP_INCLUDES ${SIP_INCLUDES})

SET(SIP_DISABLE_FEATURES ${SIP_DISABLE_FEATURES} QSETINT_CONVERSION)
SET(SIP_DISABLE_FEATURES ${SIP_DISABLE_FEATURES} QSETTYPE_CONVERSION)
SET(SIP_DISABLE_FEATURES ${SIP_DISABLE_FEATURES} QVECTORINT_CONVERSION)
SET(SIP_DISABLE_FEATURES ${SIP_DISABLE_FEATURES} HAVE_QSCI_SIP)

# globe module
SET (CMAKE_RUNTIME_OUTPUT_DIRECTORY ${QGIS_PYTHON_OUTPUT_DIRECTORY})
SET (CMAKE_LIBRARY_OUTPUT_DIRECTORY ${QGIS_PYTHON_OUTPUT_DIRECTORY})
FILE(GLOB_RECURSE sip_files_vbs *.sip)
SET(SIP_EXTRA_FILES_DEPEND ${sip_files_vbs})
SET(SIP_EXTRA_OPTIONS ${PYQT4_SIP_FLAGS} -o -a ${CMAKE_BINARY_DIR}/python/qgis.vbs.api)
ADD_SIP_PYTHON_MODULE(qgis._vbs vbs.sip vbsfunctionality qgis_core qgis_gui)

# Plugin utilities files to copy to staging or install
SET(PY_FILES
  __init__.py
)

# stage to output to make available when QGIS is run from build directory
ADD_CUSTOM_TARGET(vbspyutils ALL)
FOREACH(pyfile ${PY_FILES})
  ADD_CUSTOM_COMMAND(TARGET vbspyutils
    POST_BUILD
    COMMAND ${CMAKE_COMMAND} -E copy ${pyfile} "${QGIS_VBS_PYTHON_OUTPUT_DIRECTORY}"
    WORKING_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}
    DEPENDS ${pyfile}
  )
ENDFOREACH(pyfile)

# Byte-compile staged PyQGIS utilities
IF(WITH_PY_COMPILE)
  ADD_CUSTOM_TARGET(pycompile-pyutils ALL
    COMMAND ${PYTHON_EXECUTABLE} -m compileall -q "${QGIS_VBS_PYTHON_OUTPUT_DIRECTORY}"
    WORKING_DIRECTORY "${CMAKE_BINARY_DIR}"
    COMMENT "Byte-compiling staged PyQGIS utility modules..."
    DEPENDS vbspyutils
  )
ENDIF(WITH_PY_COMPILE)
